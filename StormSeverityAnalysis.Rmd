---
title: "Reproducible Research: Storm Severity Analysis"
output: 
  html_document:
    keep_md: true
---

## Questions
1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

## Project Setup

The libraries used in this analysis are:
```{r setup}
library(reshape2)
library(data.table)
library(plyr); library(dplyr)
library(ggplot2)
```

## Loading and preprocessing

The data comes from the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. An intermediate download location for this class is hosted on cloudfront:

```{r download, cache=TRUE}
setwd("~/../datascience/storm-severity")
dir.create("data")

dlURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
filepath <- "data/StormData.csv.bz2"

# set browser to download file through IE protocol (for https)
setInternet2(use = TRUE)
download.file(dlURL, destfile = filepath, mode="wb")
```

```{r load, cache=TRUE}
stormdata <- read.csv(filepath, stringsAsFactors=FALSE);
```

To answer the two questions posed earlier we only need to care about the columns for `EVTYPE`, `FATALITIES`, `INJURIES`, `PROPDMG`, `PROPDMGEXP`, `CROPDMG`, `CROPDMGEXP`, and `REMARKS`. 
```{r preprocess}
stormdat <- data.table(select(stormdata, EVTYPE, FATALITIES:CROPDMGEXP, REMARKS))
stormdat <- mutate(stormdat, EVTYPE=factor(EVTYPE), 
                   PROPDMGEXP=factor(PROPDMGEXP), 
                   CROPDMGEXP=factor(CROPDMGEXP))
dim(stormdat)
sapply(stormdat[1,], class)
head(stormdat)
```

## Any missing Values? 
```{r NAcount}
NA.count <- !complete.cases(select(stormdat, FATALITIES:PROPDMG, CROPDMG))
```
There are `r sum(NA.count)` rows with NA values.

## Reducing data set for ease of manipulation
This is a fairly large data set, especially considering the need to do some fairly manual cleaning of the EVTYPE data, as discussed below. The below plots show the range of values present in the adverse effects. 

```{r data.range}
histlog <- function(x, base) pmax(log(x,base),rep(0, length(x)))
ggplot(filter(stormdat, FATALITIES > 0))+
    geom_boxplot(aes(1,log(FATALITIES,10)))
```

```{r data.focus}
# filter for adverse effects > 0
stormdat <- filter(stormdat, (FATALITIES+INJURIES+PROPDMG+CROPDMG) > 0)
dim(stormdat)
```

## Managing EVTYPE variable
There are `r length(unique(stormdat$EVTYPE))` different event types in `EVTYPE`, which is much larger than the defined list in the [NOAA instruction sheet](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf). Let's see if this can be cleaned up. 

```{r evtype.cleanup}
# clean up variations
stormdat <- mutate(stormdat, 
                   EVTYPE=str_trim(EVTYPE),
                   EVTYPE=tolower(EVTYPE),
                   EVTYPE=gsub("\\.$", "", EVTYPE),
                   EVTYPE=gsub("/ ", "/", EVTYPE))

evtypes <- unique(stormdat$EVTYPE)
length(evtypes)
```
That helped a little, but there's still too much data.

Taking a look at values of `EVTYPE`:
```{r evtype.values}
head(evtypes, 15)
```
shows several spelling variations for the entry `THUNDERSTORM WINDS`. Also various hurricanes are named and labeled with variations such as `Hurricane Opal`, `Hurricane Erin`, `Hurricane Opal/High Winds`. 

The "real" event types are extracted from the table of contents of the NOAA instruction sheet.
```{r evtype.definition}
# get event types from event types text file
evtypes.raw <- readLines("data/event types.txt", warn=F)

# extract 1st-level event types, excluding "...", page numbers and other data
#   "7.2 Words, (with-stuff/other stuff) "
evtypes.def <- str_extract_all(evtypes.raw, 
                               "^[0-9]+\\.[0-9]+\\s[A-Za-z\\s,/()-]{2,}")

# remove empty rows
evtypes.def <- unlist(evtypes.def[sapply(evtypes.def, length) > 0])

# remove leading numbers and trailing (<char>)
evtypes.def <- str_sub(evtypes.def, 
                       str_locate(evtypes.def, "[0-9] ")[,2]+1, 
                       str_locate(evtypes.def, " \\([A-Z]\\)")[,1]-1)

evtypes.def <- tolower(evtypes.def)
```

While a _slightly_ more reproducible approach would be to merge the evtypes.def and evtypes variables via code, time constraints required a manual name-value-pair mapping. This mapping was initialized from the below code then the messy event types were mapped by hand to the `r length(evtypes.def)` defined event types from above. 
```{r evtype.mapping}

# organize event type data to match evtype.def
evtypes <- evtypes[order(evtypes)]
evtypes <- data.table(type.raw=evtypes)

# closest match usling Levenshtein Distance
# see: http://stackoverflow.com/questions/5721883/agrep-only-return-best-matches
ClosestMatch = function(string, stringVector){

  distance = levenshteinSim(string, stringVector);
  stringVector[distance == max(distance)]

}
evtypes <- mutate(evtypes, type.mapped=sapply(type.raw, 
                                              ClosestMatch, 
                                              stringVector=evtypes.def))

# export to text file for viewing
outfilename <- "data/event mapping raw.txt"
file.create(outfilename)
writeLines(evtypes.def, outfilename)
con <- file(outfilename, open="a")
writeLines(c(" ", as.character(evtypes)), con)
close(con)

# create file only if it doesn't already exist, this is a 1-time use
mappingfilename <- "data/event mapping.txt"
if (!file.exists(mappingfilename)) file.copy(outfilename, mappingfilename)

# MANUAL EDITS TO data/event mapping.txt OCCURED HERE

# read in mapped data
#evtypes.mapping <- read.csv(mappingfilename)


```

The finished mapping is stored in `r mappingfilename`.

## Storm effects on health

### Definition of storm severity

### Worst event type
```{r top.disasters}

```

## Storm effects on economy

### Definition of storm severity

### Worst event type